{
  "trainer": {
    "settings": {
      "accelerator": "ddp",
      "gpus": 4,
      "benchmark": true,
      "amp_backend": "apex",
      "amp_level": "O2",

      "max_steps": 25000,
      "check_val_every_n_epoch": 10,
      "terminate_on_nan": true,

      "auto_lr_find": false,

      "default_root_dir": "models",
      "log_every_n_steps": 10,
      "resume_from_checkpoint": null
    },

    "callbacks": [
      {
          "name": "LearningRateMonitor"
      },
      {
          "name": "ModelCheckpoint",
          "args": {
            "filename": "best_model",
            "monitor": "val_meandice",
            "mode": "max",
            "save_last": true,
            "save_top_k": 1
          }
      }
    ]
  },

  "workflow": {
    "name": "SupervisedSegmentation",

    "settings": {
      "num_classes": 3,
      "learning_rate": 5e-4,
      "scheduler": {
        "interval": "step",
        "frequency": 1
      }
    },

    "components": {
      "model": {
        "name": "UNETR",
        "args": {
          "in_channels": 1,
          "out_channels": 3,
          "img_size": [96, 96, 96]
        }
      },
      "inferer": {
        "name": "SlidingWindowInferer",
        "args": {
          "roi_size": [96, 96, 96],
          "sw_batch_size": 4,
          "overlap": 0.5
        }
      },
      "loss": {
        "name": "DiceCELoss",
        "args": {
          "include_background": true,
          "to_onehot_y": true,
          "softmax": true
        }
      },
      "optimizer": {
        "name": "AdamW",
        "args": {
          "lr": 1e-4
        }
      },
      "scheduler": {
        "name": "CosineAnnealingWarmRestarts",
        "args": {
          "T_0": 2500,
          "T_mult": 10,
          "eta_min": 1e-5
        }
      },
      "post_transforms": {
        "training": [
          {
            "name": "AsDiscreted",
            "path": "manafaln.transforms",
            "args": {
              "keys": ["preds", "label"],
              "argmax": [true, false],
              "to_onehot": [true, true],
              "num_classes": 3,
              "channel_dim": 1
            }
          }
        ],
        "validation": [
          {
            "name": "AsDiscreted",
            "path": "manafaln.transforms",
            "args": {
              "keys": ["preds", "label"],
              "argmax": [true, false],
              "to_onehot": [true, true],
              "num_classes": 3,
              "channel_dim": 1
            }
          },
          {
            "name": "SplitChanneld",
            "args": {
              "keys": ["preds", "label"],
              "output_postfixes": ["background", "pancreas", "tumor"],
              "channel_dim": 1
            }
          }
        ],
        "test": [
          {
            "name": "SqueezeDimd",
            "args": {
              "keys": "preds",
              "dim": 0
            }
          },
          {
            "name": "AsDiscreted",
            "args": {
              "keys": "preds",
              "argmax": true,
              "num_classes": 3
            }
          }
        ]
      },
      "training_metrics": [
        {
          "name": "DiceMetric",
          "log_label": "train_meandice",
          "output_transform": "lambda x: (x['preds'], x['label'])",
          "args": {
            "include_background": false,
            "reduction": "mean",
            "get_not_nans": false
          }
        },
        {
          "name": "ConfusionMatrixMetric",
          "log_label": ["train_sensitivity", "train_specificity", "train_accuracy"],
          "output_transform": "lambda x: (x['preds'], x['label'])",
          "args": {
            "include_background": false,
            "metric_name": ["sensitivity", "specificity", "accuracy"],
            "compute_sample": true,
            "reduction": "mean",
            "get_not_nans": false
          }
        }
      ],
      "validation_metrics": [
        {
          "name": "DiceMetric",
          "log_label": "val_meandice",
          "output_transform": "lambda x: (x['preds'], x['label'])",
          "args": {
            "include_background": false,
            "reduction": "mean",
            "get_not_nans": false
          }
        },
        {
          "name": "ConfusionMatrixMetric",
          "log_label": ["val_sensitivity", "val_specificity", "val_accuracy"],
          "output_transform": "lambda x: (x['preds'], x['label'])",
          "args": {
            "include_background": false,
            "metric_name": ["sensitivity", "specificity", "accuracy"],
            "compute_sample": true,
            "reduction": "mean",
            "get_not_nans": false
          }
        }
      ]
    }
  },

  "data": {
    "name": "DecathlonDataModule",

    "settings": {
      "data_root": "/work/pancreas/nvidia-tlt/dataset/model/pancreas/MSD",
      "data_list": "/work/pancreas/nvidia-tlt/dataset/model/pancreas/MSD/datalist.json",
      "is_segmentation": true,

      "use_shm_cache": false,
      "shm_cache_path": "/dev/shm"
    },

    "training": {
      "data_list_key": "training",
      "transforms": [
        {
          "name": "LoadImaged",
          "args": {
            "keys": ["image", "label"]
          }
        },
        {
          "name": "AddChanneld",
          "args": {
            "keys": ["image", "label"]
          }
        },
        {
          "name": "Orientationd",
          "args": {
            "keys": ["image", "label"],
            "as_closest_canonical": true
          }
        },
        {
          "name": "ScaleIntensityRanged",
          "args": {
            "keys": ["image"],
            "a_min": -200.0,
            "a_max":  250.0,
            "b_min":   -1.0,
            "b_max":    1.0,
            "clip": true
          }
        },
        {
          "name": "RandCropByPosNegLabeld",
          "args": {
            "keys": ["image", "label"],
            "label_key": "label",
            "spatial_size": [96, 96, 96],
            "pos": 1.0,
            "neg": 1.0,
            "num_samples": 4,
            "image_key": "image",
            "image_threshold": 0.0
          }
        },
        {
          "name": "RandShiftIntensityd",
          "args": {
            "keys": ["image"],
            "offsets": 0.1,
            "prob": 0.8
          }
        },
        {
          "name": "EnsureTyped",
          "args": {
            "keys": ["image", "label"]
          }
        }
      ],
      "dataset": {
        "name": "CacheDataset",
        "args": {
          "cache_rate": 0.3,
          "num_workers": 6
        }
      },
      "dataloader": {
        "name": "DataLoader",
        "args": {
          "batch_size": 4,
          "shuffle": true,
          "pin_memory": true,
          "num_workers": 6
        }
      }
    },

    "validation": {
      "data_list_key": "validation",
      "transforms": [
        {
          "name": "LoadImaged",
          "args": {
            "keys": ["image", "label"]
          }
        },
        {
          "name": "AddChanneld",
          "args": {
            "keys": ["image", "label"]
          }
        },
        {
          "name": "Orientationd",
          "args": {
            "keys": ["image", "label"],
            "as_closest_canonical": true
          }
        },
        {
          "name": "ScaleIntensityRanged",
          "args": {
            "keys": ["image"],
            "a_min": -200.0,
            "a_max":  250.0,
            "b_min":   -1.0,
            "b_max":    1.0,
            "clip": true
          }
        },
        {
          "name": "EnsureTyped",
          "args": {
            "keys": ["image", "label"]
          }
        }
      ],
      "dataset": {
        "name": "Dataset"
      },
      "dataloader": {
        "name": "DataLoader",
        "args": {
          "batch_size": 1,
          "shuffle": false,
          "pin_memory": true,
          "num_workers": 4
        }
      }
    },

    "test": {
      "data_list_key": "testing",
      "transforms": [
        {
          "name": "LoadImaged",
          "args": {
            "keys": ["image"]
          }
        },
        {
          "name": "AddChanneld",
          "args": {
            "keys": ["image"]
          }
        },
        {
          "name": "Orientationd",
          "args": {
            "keys": ["image"],
            "as_closest_canonical": true
          }
        },
        {
          "name": "ScaleIntensityRanged",
          "args": {
            "keys": ["image"],
            "a_min": -200.0,
            "a_max":  250.0,
            "b_min":   -1.0,
            "b_max":    1.0,
            "clip": true
          }
        },
        {
          "name": "EnsureTyped",
          "args": {
            "keys": ["image"]
          }
        }
      ],
      "dataset": {
        "name": "Dataset"
      },
      "dataloader": {
        "name": "DataLoader",
        "args": {
          "batch_size": 1,
          "shuffle": false,
          "pin_memory": true,
          "num_workers": 4
        }
      }
    }
  }
}
